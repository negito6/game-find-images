<html>
<head>
<title>Find Same Images</title>
<style type="text/css">
p {
  text-align: center;
}
table {
  border-collapse: separate;
  border-spacing: 3px;
  margin: 0 auto;
}
tbody.cells tr td {
  border-width: 3px;
  border-style: solid;
  border-color: #ffffff;
}
tbody.cells tr td.selected.not_wrong {
  border-color: #ffcccc;
}
tbody.cells tr td.selected.wrong {
  border-color: #990099;
}
tbody.cells tr td.selected {
  border-color: #ff0000;
}
</style>
<script type="text/javascript">
(function() {

var images = [         // Set base64 encoded images
];

(function(images) {
var self = {
  _timer: null,
  _startTime: null,
  _rows: null,
  _cols: null,

  rows: function() {
    return self._rows;
  },
  images: function() {
    return images;
  },
  cols: function() {
    return self._cols;
  },
  toggle: function(element) {
    if (element.className.match(/selected/)) {
      self.unselect(element);
    } else {
      self.select(element);
    }
  },
  select: function(element) {
    var answers = self.answers();
    if (self.selected().length >= answers.length) {
      return;
    }
    element.className = element.className + ' selected';

    if (self.selected().length == answers.length) {
      if (self.judge()) {
        self.finish();
        self.start();
      }
    }
  },
  selected: function() {
    return document.getElementsByClassName('selected')
  },
  stopTimer: function() {
    self._timer = null;
  },
  finish: function() {
    self.stopTimer();
    alert('Congratulations !');
  },
  unselect: function(element) {
    var selected = self.selected();
    for (var i = 0, l = selected.length; i < l; i++) {
      selected[i].className = selected[i].className.replace(/not_wrong/g, '').replace(/ +/g, ' ');
    }
    element.className = element.className.replace(/selected/g, '').replace(/wrong/g, '').replace(/ +/g, ' ');
  },
  answers: function() {
    return document.getElementsByClassName(self.answer());
  },
  answer: function() {
    var ids = [];
    var tds = document.getElementsByTagName('td');
    for (var i = 0, l = tds.length; i < l; i++) {
      if (tds[i].className.match(/(image\d+)/)) { 
        ids.push(RegExp.$1);
      }
    }
    for (var i = 0, l = ids.length; i < l; i++) {
      if (ids.indexOf(ids[i]) != i) {
        return ids[i];
      }
    }
    console.error('No Answer');
  },
  judge: function() {
    var selected = self.selected();
    var answer = self.answer();
    for (var i = 0, l = selected.length; i < l; i++) {
      if (selected[i].className.match(/(image\d+)/)) { 
        if (RegExp.$1 != answer) { 
          selected[i].className = selected[i].className + ' wrong';
        }
      }
    }
    var ok = document.getElementsByClassName('wrong').length == 0
    for (var i = 0, l = selected.length; i < l; i++) {
      if (!selected[i].className.match(/wrong/)) {
        selected[i].className = selected[i].className + ' not_wrong';
      }
    }
    return ok;
  },
  randomNum: function(max) {
    return Math.floor(Math.random() * max) + 1;
  },
  randomizeIndexes: function() {
    var source = self.images().length;
    var ids = [];
    var cells = self.rows() * self.cols();
    for (var i = 0; i < source; i++) {
      ids.push(i);
    }
    var answer = self.randomNum(source);
    for (var i = source; i < cells; i++) {
      ids.push(answer - 1);
    }
    return ids;
  },
  initTable: function() {
    document.getElementsByClassName('cells')[0].innerHTML = '';

    var ids = self.randomizeIndexes();

    var html = '';
    for (var i = 0; i < self.rows(); i++) {
      var tr = '<tr>';
      for (var j = 0; j < self.cols(); j++) {
        var num = ids.splice(self.randomNum(ids.length) - 1, 1);
        var num_text = num > 9 ? num : ('0' + num);
        tr += '<td class="%{id}"><img src="data:image/png;base64,%{image}"></td>'.replace(/%{id}/g, 'image'+num_text).replace(/%{image}/g, self.images()[num]); 
      }
      html += tr + '</tr>';
    }
    document.getElementsByClassName('cells')[0].innerHTML = html;
    var tds = document.getElementsByTagName('td');
    for (var i = 0, l = tds.length; i < l; i++) {
      tds[i].onclick = function() { self.toggle(this); }; 
    }
  },
  start: function() {
    var difficulty = 3;
    var minimum = 4;
    self._rows = self.randomNum(difficulty) + minimum;
    self._cols = self.randomNum(difficulty) + minimum;

    self.initTable();

    self._startTime = self.now();
    self._timer = setInterval(self.updateElapsed, 19);
  },
  updateElapsed: function() {
    var max = 1000;
    var elapsed = self.elapsed();
    if (elapsed > max) {
      self.stopTimer();
      document.getElementsByClassName('elapsed')[0].innerHTML = 'Over ' + max;
    } else {
      var elapsed_text = elapsed + '';
      if (elapsed_text.indexOf('.') < 0) {
        elapsed_text += '.00';
      } else if (elapsed_text.match(/(\.\d)$/)) {
        elapsed_text += '0';
      }
      document.getElementsByClassName('elapsed')[0].innerHTML = elapsed_text;
    }
  },
  now: function() {
    return (new Date()).getTime();
  },
  elapsed: function() {
    return parseInt((self.now() - self._startTime)/10)/100;
  },
  init: function() {
    self.start();
  },
}

window.onload = function() { self.init(); }

})(images);

})();
</script>
</head>
<body>
<table>
<tbody class="cells">
</tbody>
</table>
</body>
<p><span class="elapsed">0</span>seconds</p>
</html>
